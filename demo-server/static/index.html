<!doctype html>
<html>
<head>
	<title>Keybase Signing Login Demo</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.3.2.js"></script>
	<script type="text/javascript">
		var socket, user;
		function createKbElements(blob) {
			var input_string = "<input type=\"text\" style=\"width: 1px !important; height: 1px !important; position:absolute !important; top:-100px !important; left: -100px !important;\" />";
			$(input_string).attr("id", "kb-login-blob").prependTo($("body")).val(JSON.stringify(blob));
			$(input_string).attr("id", "kb-user-blob").prependTo($("body"));
		}

		function userChangeHandler() {
			var val;

			if (Object.getPrototypeOf(this) === HTMLInputElement.prototype && (val=$(this).val())) {
				user = JSON.parse(val);
				$("#name").text(user.full_name);
				$("#name-container").removeClass("hidden");
				$("#message,#submit").prop("disabled", false);
			} else {
				$("#name").text("");
				$("#name-container").addClass("hidden");
				$("#message,#submit").prop("disabled", true);
			}
		}

		$(document).ready(function() {
			socket = io();

			socket.on("chat_message", function(obj) {
				var user = obj.user;
				var message = obj.message;
				$('#messages').append($('<li>').text(user + ": " + message));
				window.scrollTo(0, document.body.scrollHeight);
			});

			userChangeHandler();
			$.ajax({
				url: "/api/get_blob/",
				type: "GET",
				success: function (blob) {
					createKbElements(blob);

					$("#kb-user-blob").change(userChangeHandler);
				}
			});

			$("form").submit(function() {
				var msg = $("#message");
				socket.emit("chat_message", {
					message: msg.val(),
					token: user.token
				});
				msg.val("");
			});
		});
	</script>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			outline: none;
		}

		body, input, button, span {
			font-family: "Segoe UI", "Bitstream Vera Sans", "Lucida Grande", Tahoma, sans-serif;
			font-size: 1.4rem;
			font-size: 14px;
		}

		form {
			border-top: 1px solid #88aaee;
			background-color: #f6f6f6;
			position: fixed;
			bottom: 0;
			width: 100%;
			display: table;
		}

		.entry-container {
			display: table-cell;
		}

		#name-container {
			padding: 6px 3px 6px 12px;
			width: 150px;
		}

		#name:after {
			content: ':';
		}

		#input-container {
			padding: 6px 3px 6px 6px;
		}

		#button-container {
			width: 120px;
			padding: 6px 6px 6px 3px;
		}

		input, button {
			padding: 5px;
			border-radius: 2px;
			border: 1px solid #88aaee;
			color: #365FB3;
			width: 100%;
		}

		button {
			background-color: #bbccff;
		}

		input:focus, button:focus {
			border-width: 2px;
			padding: 4px;
		}

		button:active {
			background-color: #88aaee;
			color: #ffffff;
		}

		button[disabled] {
			background-color: #D8E0F2;
			color: #cccccc;
		}

		.hidden {
			display: none !important;
		}

		#messages {
			list-style-type: none;
			margin: 0 0 40px 0;
			padding: 0;
		}

		#messages li {
			padding: 5px 10px;
		}

		#messages li:nth-child(odd) {
			background: #eee;
		}
	</style>
</head>
<body>
	<ul id="messages"></ul>
	<form action="#">
		<div class="entry-container hidden" id="name-container">
			<span id="name" />
		</div>
		<div class="entry-container" id="input-container">
			<input id="message" autocomplete="off" />
		</div>
		<div class="entry-container" id="button-container">
			<button id="submit">Send</button>
		</div>
	</form>
</body>
</html>

